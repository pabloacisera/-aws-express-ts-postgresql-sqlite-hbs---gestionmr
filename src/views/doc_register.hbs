<link rel="stylesheet" href="/css/doc_register.css">
/* Estilos para los inputs de fecha */

<style>
    /* Estilos para los inputs de fecha */
    .date-input-group {
        margin-top: 10px;
        margin-bottom: 10px;
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .date-input-group label {
        font-size: 12px;
        font-weight: 500;
        color: #495057;
        display: block;
        margin-bottom: 4px;
    }

    .date-input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .date-input:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .date-input-group small {
        font-size: 11px;
        color: #6c757d;
        display: block;
        margin-top: 4px;
    }

    /* Para tarjetas deshabilitadas */
    .cert-card.disabled .date-input {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* Estilos para tarjetas resaltadas en renovaci√≥n */
    .cert-card.highlighted {
        border: 2px solid #dc3545 !important;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.3) !important;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.3); }
        50% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.5); }
        100% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.3); }
    }
</style>

<input type="hidden" id="control-id" value="{{controlId}}" />

<div class="container mt-4">
    <div class="mb-4">
        <h2>Documentaci√≥n del Registro</h2>
        <p class="text-muted">Gesti√≥n de certificados para el control ID: {{controlId}}</p>
        
        <!-- NUEVO: Informaci√≥n de renovaci√≥n si viene de stats -->
        {{#if queryParams}}
        <div class="alert alert-info">
            <i class="fas fa-sync-alt me-2"></i>
            <strong>Modo renovaci√≥n:</strong> Est√°s renovando un documento vencido. 
            Por favor, sube el nuevo documento e ingresa la nueva fecha de vencimiento.
        </div>
        {{/if}}
    </div>

    <!-- Estado general -->
    {{#if statusCertificates.allComplete}}
    <div class="status-badge status-complete mb-1">
        ‚úÖ Todos los certificados est√°n completos
    </div>
    {{else}}
    <div class="status-badge status-incomplete mb-1">
        ‚ö†Ô∏è Faltan {{statusCertificates.missingFields.length}} certificado(s)
    </div>
    {{/if}}

    <!-- Lista de certificados pendientes -->
    {{#unless statusCertificates.allComplete}}
    <div class="missing-fields-section mb-1">
        <div class="missing-title">
            <span>üìã Certificados pendientes:</span>
        </div>
        <ul class="missing-list mb-1">
            {{#each statusCertificates.missingFields}}
            <li class="missing-item">‚Ä¢ {{this}}</li>
            {{/each}}
        </ul>
    </div>
    {{/unless}}

    <form id="certificates-form" action="/api/certificates/upload" method="POST" enctype="multipart/form-data">
        <div class="cert-grid">
            <!-- Los 4 certificados se renderizan din√°micamente seg√∫n los booleanos -->

            <!-- Certificado de Matriculaci√≥n -->
            {{#if statusCertificates.c_matriculacion_cert}}
            <!-- VERSI√ìN HABILITADA -->
            <div class="cert-card enabled {{#if (eq queryParams.tipo 'c_matriculacion')}}highlighted{{/if}}" 
                 id="card_c_matriculacion">
                <div class="cert-header">
                    <div class="cert-title">üìã Certificado de Matriculaci√≥n</div>
                    <div class="cert-icon enabled">‚úì</div>
                </div>
                <p class="cert-description">
                    Documento oficial que acredita la matriculaci√≥n del veh√≠culo.
                </p>
                <input type="file" name="doc_c_matriculacion_cert" id="doc_c_matriculacion_cert"
                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="cert-file-input">

                <!-- INPUT DE FECHA DE VENCIMIENTO -->
                <div class="date-input-group">
                    <label for="c_matriculacion_venc">Fecha de vencimiento (opcional):</label>
                    <input type="date" id="c_matriculacion_venc" name="c_matriculacion_venc"
                        class="form-control date-input" {{#if queryParams.expirationDate}}value="{{queryParams.expirationDate}}"{{/if}}>
                    <small class="text-muted">Solo si est√°s reemplazando un documento vencido</small>
                </div>

                <div class="cert-status status-available">
                    ‚úÖ Disponible para subir
                    {{#if (eq queryParams.tipo 'c_matriculacion')}}
                    <div class="text-danger mt-1">
                        <i class="fas fa-exclamation-circle"></i> 
                        {{#if (eq queryParams.estado 'vencidos')}}¬°VENCIDO!{{else}}Pr√≥ximo a vencer{{/if}}
                    </div>
                    {{/if}}
                </div>
            </div>
            {{else}}
            <!-- VERSI√ìN DESHABILITADA -->
            <div class="cert-card disabled">
                <div class="cert-header">
                    <div class="cert-title">üìã Certificado de Matriculaci√≥n</div>
                    <div class="cert-icon disabled">‚úó</div>
                </div>
                <p class="cert-description">
                    Documento oficial que acredita la matriculaci√≥n del veh√≠culo.
                </p>
                <input type="file" name="doc_c_matriculacion_cert" id="doc_c_matriculacion_cert"
                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="cert-file-input" disabled>

                <!-- INPUT DE FECHA DESHABILITADO -->
                <div class="date-input-group">
                    <label for="c_matriculacion_venc">Fecha de vencimiento:</label>
                    <input type="date" id="c_matriculacion_venc" name="c_matriculacion_venc"
                        class="form-control date-input" disabled>
                    <small class="text-muted">No disponible</small>
                </div>

                <div class="cert-status status-pending">
                    ‚è≥ Pendiente de habilitaci√≥n
                </div>
            </div>
            {{/if}}

            <!-- Certificado de Seguro -->
            {{#if statusCertificates.seguro_cert}}
            <!-- VERSI√ìN HABILITADA -->
            <div class="cert-card enabled {{#if (eq queryParams.tipo 'seguro')}}highlighted{{/if}}" 
                 id="card_seguro">
                <div class="cert-header">
                    <div class="cert-title">üõ°Ô∏è Certificado de Seguro</div>
                    <div class="cert-icon enabled">‚úì</div>
                </div>
                <p class="cert-description">
                    P√≥liza de seguro vigente del veh√≠culo con cobertura completa.
                </p>
                <input type="file" name="doc_seguro_cert" id="doc_seguro_cert" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    class="cert-file-input">

                <!-- INPUT DE FECHA DE VENCIMIENTO -->
                <div class="date-input-group">
                    <label for="seguro_venc">Fecha de vencimiento (opcional):</label>
                    <input type="date" id="seguro_venc" name="seguro_venc" class="form-control date-input"
                           {{#if queryParams.expirationDate}}value="{{queryParams.expirationDate}}"{{/if}}>
                    <small class="text-muted">Solo si est√°s reemplazando un documento vencido</small>
                </div>

                <div class="cert-status status-available">
                    ‚úÖ Disponible para subir
                    {{#if (eq queryParams.tipo 'seguro')}}
                    <div class="text-danger mt-1">
                        <i class="fas fa-exclamation-circle"></i> 
                        {{#if (eq queryParams.estado 'vencidos')}}¬°VENCIDO!{{else}}Pr√≥ximo a vencer{{/if}}
                    </div>
                    {{/if}}
                </div>
            </div>
            {{else}}
            <!-- VERSI√ìN DESHABILITADA -->
            <div class="cert-card disabled">
                <div class="cert-header">
                    <div class="cert-title">üõ°Ô∏è Certificado de Seguro</div>
                    <div class="cert-icon disabled">‚úó</div>
                </div>
                <p class="cert-description">
                    P√≥liza de seguro vigente del veh√≠culo con cobertura completa.
                </p>
                <input type="file" name="doc_seguro_cert" id="doc_seguro_cert" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    class="cert-file-input" disabled>

                <!-- INPUT DE FECHA DESHABILITADO -->
                <div class="date-input-group">
                    <label for="seguro_venc">Fecha de vencimiento:</label>
                    <input type="date" id="seguro_venc" name="seguro_venc" class="form-control date-input" disabled>
                    <small class="text-muted">No disponible</small>
                </div>

                <div class="cert-status status-pending">
                    ‚è≥ Pendiente de habilitaci√≥n
                </div>
            </div>
            {{/if}}

            <!-- Certificado RTO -->
            {{#if statusCertificates.rto_cert}}
            <!-- VERSI√ìN HABILITADA -->
            <div class="cert-card enabled {{#if (eq queryParams.tipo 'rto')}}highlighted{{/if}}" 
                 id="card_rto">
                <div class="cert-header">
                    <div class="cert-title">üöó Certificado RTO</div>
                    <div class="cert-icon enabled">‚úì</div>
                </div>
                <p class="cert-description">
                    Certificado de Registro de Transporte de Oficina (RTO).
                </p>
                <input type="file" name="doc_rto_cert" id="doc_rto_cert" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    class="cert-file-input">

                <!-- INPUT DE FECHA DE VENCIMIENTO -->
                <div class="date-input-group">
                    <label for="rto_venc">Fecha de vencimiento (opcional):</label>
                    <input type="date" id="rto_venc" name="rto_venc" class="form-control date-input"
                           {{#if queryParams.expirationDate}}value="{{queryParams.expirationDate}}"{{/if}}>
                    <small class="text-muted">Solo si est√°s reemplazando un documento vencido</small>
                </div>

                <div class="cert-status status-available">
                    ‚úÖ Disponible para subir
                    {{#if (eq queryParams.tipo 'rto')}}
                    <div class="text-danger mt-1">
                        <i class="fas fa-exclamation-circle"></i> 
                        {{#if (eq queryParams.estado 'vencidos')}}¬°VENCIDO!{{else}}Pr√≥ximo a vencer{{/if}}
                    </div>
                    {{/if}}
                </div>
            </div>
            {{else}}
            <!-- VERSI√ìN DESHABILITADA -->
            <div class="cert-card disabled">
                <div class="cert-header">
                    <div class="cert-title">üöó Certificado RTO</div>
                    <div class="cert-icon disabled">‚úó</div>
                </div>
                <p class="cert-description">
                    Certificado de Registro de Transporte de Oficina (RTO).
                </p>
                <input type="file" name="doc_rto_cert" id="doc_rto_cert" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    class="cert-file-input" disabled>

                <!-- INPUT DE FECHA DESHABILITADO -->
                <div class="date-input-group">
                    <label for="rto_venc">Fecha de vencimiento:</label>
                    <input type="date" id="rto_venc" name="rto_venc" class="form-control date-input" disabled>
                    <small class="text-muted">No disponible</small>
                </div>

                <div class="cert-status status-pending">
                    ‚è≥ Pendiente de habilitaci√≥n
                </div>
            </div>
            {{/if}}

            <!-- Certificado de Tac√≥grafo -->
            {{#if statusCertificates.tacografo_cert}}
            <!-- VERSI√ìN HABILITADA -->
            <div class="cert-card enabled {{#if (eq queryParams.tipo 'tacografo')}}highlighted{{/if}}" 
                 id="card_tacografo">
                <div class="cert-header">
                    <div class="cert-title">üìä Certificado de Tac√≥grafo</div>
                    <div class="cert-icon enabled">‚úì</div>
                </div>
                <p class="cert-description">
                    Certificado de calibraci√≥n y funcionamiento del tac√≥grafo.
                </p>
                <input type="file" name="doc_tacografo_cert" id="doc_tacografo_cert"
                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="cert-file-input">

                <!-- INPUT DE FECHA DE VENCIMIENTO -->
                <div class="date-input-group">
                    <label for="tacografo_venc">Fecha de vencimiento (opcional):</label>
                    <input type="date" id="tacografo_venc" name="tacografo_venc" class="form-control date-input"
                           {{#if queryParams.expirationDate}}value="{{queryParams.expirationDate}}"{{/if}}>
                    <small class="text-muted">Solo si est√°s reemplazando un documento vencido</small>
                </div>

                <div class="cert-status status-available">
                    ‚úÖ Disponible para subir
                    {{#if (eq queryParams.tipo 'tacografo')}}
                    <div class="text-danger mt-1">
                        <i class="fas fa-exclamation-circle"></i> 
                        {{#if (eq queryParams.estado 'vencidos')}}¬°VENCIDO!{{else}}Pr√≥ximo a vencer{{/if}}
                    </div>
                    {{/if}}
                </div>
            </div>
            {{else}}
            <!-- VERSI√ìN DESHABILITADA -->
            <div class="cert-card disabled">
                <div class="cert-header">
                    <div class="cert-title">üìä Certificado de Tac√≥grafo</div>
                    <div class="cert-icon disabled">‚úó</div>
                </div>
                <p class="cert-description">
                    Certificado de calibraci√≥n y funcionamiento del tac√≥grafo.
                </p>
                <input type="file" name="doc_tacografo_cert" id="doc_tacografo_cert"
                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="cert-file-input" disabled>

                <!-- INPUT DE FECHA DESHABILITADO -->
                <div class="date-input-group">
                    <label for="tacografo_venc">Fecha de vencimiento:</label>
                    <input type="date" id="tacografo_venc" name="tacografo_venc" class="form-control date-input"
                        disabled>
                    <small class="text-muted">No disponible</small>
                </div>

                <div class="cert-status status-pending">
                    ‚è≥ Pendiente de habilitaci√≥n
                </div>
            </div>
            {{/if}}
        </div>

        <div class="form-actions">
            <button type="submit" class="submit-btn" id="submit-btn">
                <span>üì§ Subir Documentos</span>
                <span>‚Üí</span>
            </button>
            <button type="button" class="btn btn-outline-secondary ms-2" id="cancel-btn">
                Cancelar
            </button>
        </div>
    </form>

    <div class="footer-info">
        Estado: <strong>{{#if statusCertificates.allComplete}}Completo{{else}}Incompleto{{/if}}</strong></p>
        <p>Formatos aceptados: PDF, JPG, PNG, DOC, DOCX (M√°x. 10MB por archivo)</p>
        <p><small>Nota: Los campos de fecha son opcionales y solo se usan cuando se reemplaza un documento
                vencido.</small></p>
        <p><small>Puedes subir uno o varios documentos a la vez, seg√∫n necesites.</small></p>
    </div>
</div>

<script type="module" src="/js/doc_register.js"></script>